{
    "jpsType": "install",
    "description": "Get your highly available and scalable clustered solution for Magento, the extremely popular open source e-commerce platform. This package is designed to ensure the load tracking and distribution, as well as automatic adjusting the amount of allocated resources according to it.",
    "logo": "https://raw.githubusercontent.com/jelastic-jps/magento-cluster/master/images/magento_70x70.png",
    "name": "Magento Cluster Template",
    "globals": {
        "PATH": "https://raw.githubusercontent.com/jelastic-jps/magento/mg21-php7-varnish-memcache-storage-dbcluster",
        "DB_USER": "jelastic-${fn.random}",
        "DB_PASS": "${fn.password(20)}",
        "DB_NAME": "magento",
        "MAGE_ROOT": "/var/www/webroot/ROOT",
        "ADMIN_PASSWD": "${fn.password(10)}"
    },
    "success": "Below you will find your admin panel link, username and password.</br></br> <table style='font-size:13px; border: none;'><tr><td>Admin panel URL:</td><td style='padding-left: 10px;'><a href='${env.protocol}://${env.domain}/admin/' target='_blank'>${env.protocol}://${env.domain}/admin/</a></td></tr>  <tr><td>Admin name:</td><td style='padding-left: 10px;'>admin</td></tr><tr><td>Password:</td><td style='padding-left: 10px;'>${globals.ADMIN_PASSWD}</td></tr></table></br>To add custom domain name for your Magento Cluster installation follow the steps described in our <a href='http://docs.jelastic.com/custom-domains' target='_blank'>documentation</a>",
    "nodes": [{
        "image": "jelastic/nginxphp:1.10.1-php-7.0.10",
        "count": 2,
        "cloudlets": 8,
        "nodeGroup": "cp",
        "links": ["sqldb:DB", "memcached:MEMCACHED"],
        "volumes": ["${globals.MAGE_ROOT}"],
        "displayName": "AppServer",
        "volumeMounts": {
            "${globals.MAGE_ROOT}": {
                "readOnly": false,
                "sourcePath": "/data",
                "sourceNodeGroup": "storage"
            }
        }
    }, {
        "image": "jelastic/storaged",
        "cloudlets": 8,
        "nodeGroup": "storage",
        "displayName": "Storage"
    }, {
        "image": "jelastic/mysql:5.7-latest",
        "count": 2,
        "cloudlets": 8,
        "nodeGroup": "sqldb",
        "displayName": "Database"
    }, {
        "image": "jelastic/memcached:1.4.24",
        "cloudlets": 4,
        "count": 2,
        "nodeGroup": "memcached",
        "displayName": "Memcached"
    }, {
        "image": "jelastic/varnish:4.1.5",
        "cloudlets": 8,
        "count": 1,
        "nodeGroup": "bl",
        "displayName": "Balancer"
    }],
    "onAfterScaleOut[nodeGroup:cp]": [{
        "forEach(event.response.nodes)": {
            "setupNode": {
                "filter": "${@i.id}",
                "intIP": "${@i.intIP}"
            }
        }
    }],
    "onBeforeScaleIn[nodeGroup:cp]": {
        "forEach(event.response.nodes)": {
            "removeNode": {
                "intIP": "${@i.intIP}"
            }
        }
    },
    "onInstall": [{
        "log": "Auto Scaling Triggers"
    }, {
        "script": "https://raw.githubusercontent.com/jelastic-jps/magento-cluster/master/scripts/addTriggers.js"
    }, {
        "log": "DB Cluster Setup"
    }, {
        "installJps": {
            "jps": "https://raw.githubusercontent.com/jelastic-jps/mysql-cluster/orchestrator/scripts/cluster-configuration.jps",
            "settings": {
                "db_user": "${globals.DB_USER}",
                "db_pass": "${globals.DB_PASS}"
            }
        }
    }, {
        "log": "CP Layer Setup"
    }, {
        "forEach(nodes.cp)": {
            "setupNode": {
                "filter": "${@i.id}",
                "intIP": "${@i.intIP}"
            }
        }
    }, {
        "log": "Download and Unpack Content"
    }, {
        "cmd[storage]": [
            "wget -qO- \"https://download.jelastic.com/public.php?service=files&t=a7b742235493eda8ede55043c3d4568c&download\" | tar xz -C /data",
            "wget ${globals.PATH}/configs/magento/varnish-probe.php -O /data/varnish-probe.php",
            "wget ${globals.PATH}/configs/magento/env.php -O /data/app/etc/env.php"
        ]
    }, {
        "log": "Setup Magento Content"
    }, {
        "cmd[${nodes.cp.first.id}]": [
            "mysql -u${globals.DB_USER} -p${globals.DB_PASS} -h ${globals.DB_HOST} -e \"CREATE DATABASE IF NOT EXISTS ${globals.DB_NAME};\" ",
            "mysql -u${globals.DB_USER} -p${globals.DB_PASS} -h ${globals.DB_HOST} ${globals.DB_NAME} < ${globals.MAGE_ROOT}/magento-sample.sql",
            "wget ${globals.PATH}/scripts/setupMG.sh -O /tmp/setupMG.sh && bash /tmp/setupMG.sh ${globals.DB_USER} ${globals.DB_PASS} DB_MASTER ${globals.DB_NAME} ${globals.ADMIN_PASSWD} ${globals.MAGE_ROOT} ${env.url} ${user.email}"
        ]
    }],
    "actions": {
        "setupNode": [{
            "cmd[${this.filter}]": [
                "echo ${nodes.sqldb[0].intIP} DB_MASTER >> /etc/hosts && echo ${nodes.sqldb[1].intIP} DB_SLAVE >> /etc/hosts",
                "wget -O - ${globals.PATH}/scripts/setupCP.sh | bash",
                "wget ${globals.PATH}/configs/php/memcache.ini -O /etc/php.d/memcache.ini && wget ${globals.PATH}/configs/php/opcache.ini -O /etc/php.d/opcache.ini",
                "wget ${globals.PATH}/configs/nginx/nginx.conf -O /etc/nginx/nginx.conf",
                "/etc/init.d/nginx restart"
            ]
        }, {
            "cmd[bl]": [
                "jem balancer addCommonHost -h ${this.intIP} ",
                "grep -q \".url = \"/\"\" /etc/varnish/default.vcl ||  sed -ri 's| .url = \"/\"|.url = \"/varnish-probe.php\"|g' /etc/varnish/default.vcl",
                "service varnish reload"
            ]
        }],
        "removeNode": {
            "cmd[bl]": [
                "jem balancer RemoveCommonHost -h ${this.intIP}",
                "service varnish reload"
            ]
        }
    }
}
