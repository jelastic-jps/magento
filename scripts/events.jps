type: update
id: magento-standalone-events
name: Magento Standalone Events

globals:
  MG_SCRIPTS_PATH: https://raw.githubusercontent.com/sych74/magento-cluster/JE-66684/scripts

onAfterInstallAddon [nodeGroup:cp, id:cdn]:
  install: ${globals.MG_SCRIPTS_PATH}/setupCDN.jps
 
onAfterInstallAddon [nodeGroup:cp, id:letsencrypt-ssl-addon]:
  - cmd[cp]: source /opt/letsencrypt/settings && echo $domain
  - install: 
      jps: ${globals.MG_SCRIPTS_PATH}/setupDomain.jps?_r=${fn.random}
      settings:
        domain: ${response.out}
  - cmd[cp]: bash ~/bin/japp.sh ssl on;

onAfterClone: 
  - install: 
      jps: ${globals.MG_SCRIPTS_PATH}/setupDomain.jps?_r=${fn.random}
      envName: ${event.response.env.envName}
      settings:
        domain: ${event.response.env.domain}

  - install: 
      jps: ${globals.MG_SCRIPTS_PATH}/setupCDN.jps?_r=${fn.random}
      envName: ${event.response.env.envName}

  - script: delete MANIFEST.id; return {result:0, jps:MANIFEST};
  - install: ${response.jps}
    envName: ${event.response.env.envName}  

onBeforeMigrate:
  - cmd[${nodes.cp.master.id}]: php /var/www/webroot/ROOT/bin/magento config:show web/unsecure/base_url | cut -d'/' -f3;
  - if (/${response.out}/.test(env.domain)):
      cmd[${nodes.cp.master.id}]: echo true > ~/migrate
  - else:
      cmd[${nodes.cp.master.id}]: echo false > ~/migrate

onAfterMigrate:
  - cmd[${nodes.cp.master.id}]: if test -f ~/migrate; then cat ~/migrate; fi
  - if (/${response.out}/.test(true)):
    - install: 
        jps: ${globals.MG_SCRIPTS_PATH}/setupDomain.jps?_r=${fn.random}
        settings:
          domain: ${env.domain}
